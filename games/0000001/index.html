<!DOCTYPE html>
<html lang="en">
<head>
  <title>Game Log 0000001</title>
  <style>
    output {
      font-family: monospace
    }
  </style>
</head>
<body>
  <h1>Game log</h1>
  <form method="GET">
    <fieldset>
      <legend>Game Clock</legend>
      <output id="clock" for="clock-run"></output>
    </fieldset>
    <fieldset>
      <legend>Log triggers</legend>
      <button id="1" disabled>1</button>
      <button id="2" disabled>2</button>
      <button id="3" disabled>3</button>
      <button id="4" disabled>4</button>
      <button id="5" disabled>5</button>
      <button id="6" disabled>6</button>
      <button id="7" disabled>7</button>
      <button id="8" disabled>8</button>
      <button id="9" disabled>9</button>
    </fieldset>
    <fieldset>
      <legend>Special triggers</legend>
      <button type="button" id="clock-run" onclick="triggerClock()">Start/Stop Clock</button>
    </fieldset>
  </form>
  <details open>
    <summary>Match details</summary>
    <ol reversed id="play-log"></ol>
  </details>
  <script>
    const createTeam = (name, players) => ({ name, players })
    const createClock = () => {
      const matchTimer = 10000 // 5 minutes
      let msTicks = 0
      let prevTime = null
      let interval = null

      let remaining = {
        minutes: 5,
        seconds: 0,
        milliseconds: 0,
      }

      const clockManager = {
        start: () => {
          if( interval === null ) {
            prevTime = Date.now()
            interval = setInterval(updateClock, 10)
          }
        },
        stop: () => {
          clearInterval(interval)
          interval = null
          updateClock()
        },
        get isRunning () {
          return !!interval
        },
        get remaining () {
          return remaining
        },
        get remainingFormatted() {
          const overtime = remaining.overtime ? "+" : "\xA0"
          return `${overtime}${remaining.minutes}:${remaining.seconds.toString().padStart(2, "0")}.${remaining.milliseconds.toString().padStart(3, "0")}`
        }
      }

      const updateClock = () => {
        msTicks += Date.now() - prevTime
        prevTime = Date.now()

        let msRemaining = matchTimer - msTicks
        const doFloor = msRemaining > 0
          ? Math.floor
          : Math.ceil

        const minutes = doFloor(msRemaining / 60000)
        msRemaining -= minutes * 60000

        const seconds = doFloor(msRemaining / 1000)
        msRemaining -= seconds * 1000

        remaining = {
          minutes: Math.abs(minutes),
          seconds: Math.abs(seconds),
          milliseconds: Math.abs(msRemaining),
          overtime: msRemaining < 0
        }
      }

      return clockManager
    }
    const input = (new URL(document.location)).searchParams

    // Setup clock
    const clockManager = createClock()
    function triggerClock() {
      if(clockManager.isRunning) {
        clockManager.stop()
        log('clock stopped')
      } else {
        clockManager.start()
        log('clock started')
      }
    }
    function updateClock() {
      window['clock'].innerText = clockManager.remainingFormatted
      window.requestAnimationFrame(updateClock)
    }
    updateClock()

    const log = (...notes) => {
      notes.forEach((note) => {
        const logEl = document.createElement('li')
        logEl.append(`[${clockManager.remainingFormatted}]: ${note}`)
        window['play-log'].prepend(logEl)
      })
    }

    // Add the teams
    const teams = {
      blue: createTeam(input.get("blue-team"), input.getAll("blue-player")),
      orange: createTeam(input.get("orange-team"), input.getAll("orange-player")),
    }
    log(
      `${teams.blue.name} joined the match with: ${teams.blue.players.join(', ')}`,
      `${teams.orange.name} joined the match with: ${teams.orange.players.join(', ')}`
    )

  </script>
</body>
</html>
